<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PantryGo.ViewModels"
             xmlns:models="clr-namespace:PantryGo.Models"
             x:Class="PantryGo.Views.CartPage"
             x:DataType="vm:CartViewModel"
             Title="{Binding Title}"
             BackgroundColor="{StaticResource Background}">
    
    <Grid RowDefinitions="*,Auto">
        
        <!-- Cart Items -->
        <ScrollView Grid.Row="0" IsVisible="{Binding IsEmpty, Converter={StaticResource InvertedBoolConverter}}">
            <VerticalStackLayout Padding="16" Spacing="12">
                
                <BindableLayout.ItemsSource>
                    <Binding Path="Items"/>
                </BindableLayout.ItemsSource>
                
                <CollectionView ItemsSource="{Binding Items}" SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:CartItem">
                            <Frame Margin="0,0,0,8" Padding="12" CornerRadius="12" BackgroundColor="White">
                                <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">
                                    
                                    <!-- Product Image Placeholder -->
                                    <Frame Grid.RowSpan="3" 
                                           WidthRequest="70" 
                                           HeightRequest="70" 
                                           CornerRadius="8" 
                                           BackgroundColor="{StaticResource Gray100}"
                                           Padding="0"
                                           Margin="0,0,12,0">
                                        <Label Text="ðŸ¥¬" FontSize="30" 
                                               HorizontalOptions="Center" 
                                               VerticalOptions="Center"/>
                                    </Frame>
                                    
                                    <!-- Product Name -->
                                    <Label Grid.Column="1" Grid.Row="0" 
                                           Text="{Binding ProductName}" 
                                           FontSize="15" 
                                           FontAttributes="Bold"/>
                                    
                                    <!-- Price per unit -->
                                    <Label Grid.Column="1" Grid.Row="1" 
                                           Text="{Binding Price, StringFormat='â‚¹{0:F0} per {0}'}" 
                                           FontSize="12" 
                                           TextColor="{StaticResource Gray500}"/>
                                    
                                    <!-- Quantity Controls -->
                                    <HorizontalStackLayout Grid.Column="1" Grid.Row="2" 
                                                           Spacing="8" 
                                                           Margin="0,8,0,0">
                                        <Button Text="-" 
                                                WidthRequest="32" HeightRequest="32" 
                                                CornerRadius="16" 
                                                Padding="0"
                                                BackgroundColor="{StaticResource Gray200}"
                                                TextColor="{StaticResource Gray600}"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CartViewModel}}, Path=DecreaseQuantityCommand}"
                                                CommandParameter="{Binding}"/>
                                        <Label Text="{Binding Quantity}" 
                                               VerticalOptions="Center"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               WidthRequest="30"
                                               HorizontalTextAlignment="Center"/>
                                        <Button Text="+" 
                                                WidthRequest="32" HeightRequest="32" 
                                                CornerRadius="16" 
                                                Padding="0"
                                                BackgroundColor="{StaticResource Primary}"
                                                TextColor="White"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CartViewModel}}, Path=IncreaseQuantityCommand}"
                                                CommandParameter="{Binding}"/>
                                    </HorizontalStackLayout>
                                    
                                    <!-- Total & Remove -->
                                    <VerticalStackLayout Grid.Column="2" Grid.RowSpan="3" 
                                                         VerticalOptions="Center"
                                                         HorizontalOptions="End">
                                        <Label Text="{Binding TotalPrice, StringFormat='â‚¹{0:F0}'}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Primary}"
                                               HorizontalTextAlignment="End"/>
                                        <Label Text="Remove" 
                                               FontSize="12" 
                                               TextColor="Red"
                                               TextDecorations="Underline"
                                               Margin="0,8,0,0">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CartViewModel}}, Path=RemoveItemCommand}"
                                                    CommandParameter="{Binding}"/>
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </VerticalStackLayout>
                                    
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
            </VerticalStackLayout>
        </ScrollView>
        
        <!-- Empty Cart View -->
        <VerticalStackLayout Grid.Row="0" 
                             IsVisible="{Binding IsEmpty}" 
                             VerticalOptions="Center" 
                             Spacing="16" 
                             Padding="24">
            <Label Text="ðŸ›’" FontSize="80" HorizontalOptions="Center"/>
            <Label Text="Your cart is empty" 
                   FontSize="20" 
                   FontAttributes="Bold"
                   HorizontalOptions="Center"/>
            <Label Text="Add some items to get started" 
                   FontSize="14" 
                   TextColor="{StaticResource Gray500}"
                   HorizontalOptions="Center"/>
            <Button Text="Start Shopping" 
                    Command="{Binding ContinueShoppingCommand}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    CornerRadius="8"
                    Margin="32,16"/>
        </VerticalStackLayout>
        
        <!-- Checkout Footer -->
        <Frame Grid.Row="1" 
               IsVisible="{Binding IsEmpty, Converter={StaticResource InvertedBoolConverter}}"
               Padding="16" 
               CornerRadius="0"
               BackgroundColor="White">
            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto">
                
                <Label Grid.Row="0" Grid.Column="0" 
                       Text="Total" 
                       FontSize="14" 
                       TextColor="{StaticResource Gray500}"/>
                <Label Grid.Row="0" Grid.Column="1" 
                       Text="{Binding ItemCount, StringFormat='{0} items'}" 
                       FontSize="14" 
                       TextColor="{StaticResource Gray500}"
                       HorizontalTextAlignment="End"/>
                
                <Label Grid.Row="1" Grid.Column="0" 
                       Text="{Binding TotalPrice, StringFormat='â‚¹{0:F0}'}" 
                       FontSize="24" 
                       FontAttributes="Bold"
                       TextColor="{StaticResource Primary}"/>
                
                <Button Grid.Row="1" Grid.Column="1" 
                        Text="Checkout â†’" 
                        Command="{Binding CheckoutCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        HeightRequest="50"/>
            </Grid>
        </Frame>
        
    </Grid>
</ContentPage>
